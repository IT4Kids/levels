<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Cubi Level Manager</title>

        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <header>
            <h2>Cubi Level Manager</h2>
            <p>
                Generiert eine neue Übersicht aller Levels (<code>summary.json</code>) mit Titel, Beschreibung und
                Rating. Ihr könnt die Reihenfolge per Drag and Drop in der Liste abändern.<br><br>
                Folgt der Schritt für Schritt Anleitung und euch können keine Fehler passieren.
            </p>
        </header>

        <main>
            <section id="step-0">
                <h3>Fügt den Inhalt der aktuellen <code>summary.json</code> hier ein.</h3>
                <p>
                    Öffne <a target="_blank" href="https://github.com/IT4Kids/levels">IT4Kids/levels</a> und kopiert den Inhalt der
                    Datei <code>summary.json</code> in das Textfeld. Danach klicke auf eine leere Fläche und gehe zum
                    nächsten Schritt. <b>Tipp</b>: Standardmäßig ist die <code>summary.json</code> schon geladen.
                </p>
                <textarea id="i-current_summary" onblur="initializeSortable(this.value)" rows="15" placeholder="Paste here"></textarea>
            </section>
            <section id="step-1">
                <h3>Bearbeite die Liste</h3>
                <p>
                    Du kannst nun die Elemente an dem linken Symbol in der Liste neu sortieren, ein neues über den
                    Button hinzufügen und Elemente entfernen.
                </p>
                <div id="dropdown" style="position: fixed; top: 1cm"></div>
                <button id="new-level" onclick="newLevelItem()">Level hinzufügen</button>
                <ul id="items"></ul>
            </section>
            <section id="step-2">
                <h3>Kopiert den Inhalt hier nun in die <code>summary.json</code></h3>
                <p>
                    Wenn du bereits auf fertig geklickt hast, kannst du nun auf kopieren klicken, welches dir den Text
                    aus dem unteren Textfeld direkt in deine Zwischenablage einfügt. Nun kannst du einfach wieder auf
                    GitHub gehen, <code>summary.json</code> bearbeiten und einfach den Text direkt aus deiner
                    Zwischenablage dort einfügen.
                </p>
                <button id="copy-summary" onclick="toClipboard(document.getElementById('i-new_summary'))">Kopieren</button>
                <span id="message-copy" class="hidden">Inhalt kopiert!</span><br>
                <textarea id="i-new_summary" rows="30" disabled></textarea>
            </section>
        </main>

        <script>

            let supportedLanguages = ['de', 'en', 'nl', 'fr', 'es']
            let currentLang = new Array(supportedLanguages.length).fill(false);
            currentLang[0] = true;
            var items = document.getElementById("items"),
                uniq = 0,
                uniq_key = 0;

            function httpGet(url, callback) {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() {
                    if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                        callback(xmlHttp.responseText);
                    }
                };
                xmlHttp.open("GET", url, true);
                xmlHttp.send(null);
            }

            // load summary json
            httpGet("https://raw.githubusercontent.com/IT4Kids/levels/master/summary.json", function(d) {
               document.getElementById("i-current_summary").value = d;
                initializeSortable()
            });

            function initializeSortable() {
                generateListFromJson();
                generateDropdown();
                generateJsonFromList();
            }

            function makeSortable() {
                Sortable.create(items, {
                    handle: '.handle',
                    onChange: function () {
                        generateJsonFromList()
                    }
                });
                items.querySelectorAll('input').forEach(function(i) {
                    i.onkeyup = generateJsonFromList;
                    i.onclick = generateJsonFromList;
                })
            }

            function generateDropdown() {
                let dropdown = document.createElement('select');
                for (let lang in supportedLanguages){
                    let option = document.createElement('option');
                    option.text = supportedLanguages[lang];
                    dropdown.add(option);
                }
                dropdown.addEventListener('change', function (event) {
                    toggleShow(supportedLanguages.indexOf(event.target.value));
                })
                document.getElementById('dropdown').append(dropdown);

            }

            function toggleShow(index){
                if (currentLang[index] === true){
                    return;
                }
                let indexOfCurrentLang = currentLang.indexOf(true);
                for (let el of document.querySelectorAll('.' + supportedLanguages[indexOfCurrentLang])){
                    el.style.display = 'none';
                }
                currentLang[indexOfCurrentLang] = false;

                currentLang[index] = true;
                for (let el of document.querySelectorAll('.' + supportedLanguages[index])){
                    el.style.display = 'block';
                }
            }

            function deleteTextRow(i){
                document.getElementById('texts_row-' + i).remove();
                generateJsonFromList();
            }

            function createTextKey(i){
                let row = document.createElement("row");
                row.id = 'texts_row-' + uniq_key;
                row.name = 'texts_row';

                let column = document.createElement("column");
                let label = document.createElement("label");
                label.textContent = "Key:";
                let input = document.createElement("input");
                input.type = "text";
                input.name = "text_key";
                input.addEventListener('keyup', generateJsonFromList);
                input.value = '';
                column.appendChild(label);
                column.appendChild(input);

                let indexOfCurrentLang = currentLang.indexOf(true);
                for(let lang of supportedLanguages){
                    if(lang === supportedLanguages[indexOfCurrentLang]){
                        let ta = document.createElement('textarea');
                        ta.name = 'text_value';
                        ta.addEventListener('keyup', generateJsonFromList);
                        ta.classList.add(lang);
                        ta.style = "display: block"
                        column.appendChild(ta);
                    }
                    else{
                        let ta = document.createElement('textarea');
                        ta.name = 'text_value';
                        ta.addEventListener('keyup', generateJsonFromList);
                        ta.classList.add(lang);
                        ta.style = "display: none";
                        column.appendChild(ta);
                    }
                }

                let button = document.createElement("button");
                button.textContent = '-'
                button.name = 'button-' + uniq_key;
                let temp = uniq_key;
                button.addEventListener('click', function(){deleteTextRow(temp)});
                column.appendChild(button);
                row.appendChild(column);

                document.getElementById('text_translations-' + i).appendChild(row);
                generateJsonFromList();

                uniq_key += 1;
            }

            function generateListFromJson() {
                var value = document.getElementById("i-current_summary").value;
                if(value === "") {
                    items.innerHTML = "";
                    return;
                }
                var json = JSON.parse(value);
                items.innerHTML = "";
                for (var i = 0; i < json.length; i++) {
                    uniq = i;
                    let l = json[i];
                    let tempInnerHTML = createInnerHtml(l.title, l.rating, l.description, l.filename, l.solution_exists, l.template_exists); // TODO l.texts
                    newLevelItemWithValues(tempInnerHTML);
                }
                for (let el of document.querySelectorAll('.' + supportedLanguages[0])){
                    el.style.display = 'block';
                }
            }

            function createInnerHtml(title, rating, description, filename, checked, checked2){
                let innerHTML = "<row><column><span class='handle'><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path d=\"M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z\"/><path d=\"M0 0h24v24H0z\" fill=\"none\"/></svg></span></column>";
                for(lang of supportedLanguages){
                    if(lang === supportedLanguages[0]){
                        innerHTML += "<column  class='" + lang + " lang' style='display: block'><label>" + lang + "</label></column>";
                    }
                    else{
                        innerHTML += "<column  class='" + lang + " lang' style='display: none'><label>" + lang + "</label></column>";
                    }
                }
                innerHTML += "<column><label>Title:</label>";
                for(lang of supportedLanguages){
                    if(lang === supportedLanguages[0]){
                        innerHTML += "<input type='text' name='title' style='display: block' value='" + title[lang] + "' class='" + lang + "'>";
                    }
                    else{
                        innerHTML += "<input type='text' name='title' style='display: none' value='" + title[lang] + "' class='" + lang + "'>";
                    }
                }
                innerHTML += "</column>" +
                    "<column><label>Rating:</label> <input type='number' name='rating' min='0' max='3' value='" + rating + "'></column>" +
                    "<column><label>Filename:</label> <input type='text' name='filename' value='" + filename + "'></column>" +
                    "<column><label>Solution:</label> <input type='checkbox' name='solution_exists'" + ((checked) ? " checked" : "") + "></column>" +
                    "<column><label>Template:</label> <input type='checkbox' name='template_exists'" + ((checked2) ? " checked" : "") + "></column>" +
                    "</row>" +
                    "<label>Description:</label>";
                for(let lang of supportedLanguages){
                    if(lang === supportedLanguages[0]) {
                        innerHTML += "<textarea name='description' class='" + lang + "' style='display: block'>" + description[lang] + "</textarea>";
                    }
                    else {
                        innerHTML += "<textarea name='description' class='" + lang + "' style='display: none'>" + description[lang] + "</textarea>";
                    }

                }
                innerHTML += "</row>";

                innerHTML += "<button onclick='createTextKey(" + uniq +")'>Add new text key</button>";

                innerHTML += "<div id='text_translations-" + uniq +"' name='texts'>";
                innerHTML +="</div>"

                return innerHTML;
            }

            function newLevelItemWithValues(innerHTML, prepend) {
                var li = document.createElement("li");
                li.id = "item-" + uniq;
                li.innerHTML =  innerHTML + "<column><button class='delete' onclick='askToDelete(\"" + li.id + "\")'>Delete</button></column>";
                var inputs = li.querySelectorAll("input, textarea");
                for(var i = 0; i < inputs.length; i++) {
                    inputs[i].onkeyup = function() {
                        generateJsonFromList()
                    }
                }
                if(prepend === true) {
                    items.insertBefore(li, items.childNodes[0]);
                } else {
                    items.append(li);
                }
                makeSortable();
            }

            function newLevelItem() {
                uniq++;
                let emptyLangs = { 'title': {}, 'description': {}};
                for(let lang of supportedLanguages){
                    emptyLangs['title'][lang] = '';
                    emptyLangs['description'][lang] = '';
                }
                let innerHTML = createInnerHtml(emptyLangs['title'], "", emptyLangs['description'], "", true);
                newLevelItemWithValues(innerHTML, true);
            }

            function generateJsonFromList() {
                var items = document.getElementById("items").children;
                let json = [];
                for(var i = 0; i < items.length; i++) {
                    json.push({
                        title: {},
                        rating: parseInt(items[i].querySelector("[name='rating']").value),
                        description: {},
                        filename: items[i].querySelector("[name='filename']").value,
                        solution_exists: (items[i].querySelector("[name='solution_exists']").checked),
                        template_exists: (items[i].querySelector("[name='template_exists']").checked),
                        texts: {}
                    });
                    for(let l of supportedLanguages) {
                        json[i].title[l] = items[i].querySelector("." + l + "[name='title']").value;
                        json[i].description[l] = items[i].querySelector("." + l + "[name='description']").value;
                    }

                    // get translations: keys and respective values
                    let rows = items[i].querySelectorAll("[name='texts'] > row");
                    if (rows === []) continue;

                    let translations = {};
                    Object.values(rows).forEach((row) => {
                        let langValues = Object.assign({}, ...supportedLanguages.map((x) => ({[x]: []})));
                        let key = row.querySelector("[name='text_key']").value;
                        let values = row.querySelectorAll("[name='text_value']");
                        Object.values(values).forEach(value => {
                            langValues[value.className] = value.value;
                        })
                        translations[key] = langValues;
                    })
                    json[i]['texts'] = translations;
                }
                document.getElementById("i-new_summary").value = JSON.stringify(json);
            }

            function toClipboard(el) {
                el.disabled = false;
                el.select();
                document.execCommand("copy");
                el.disabled = true;
                document.getElementById("message-copy").classList.remove("hidden");
                setTimeout(function () {
                    document.getElementById("message-copy").classList.add("hidden");
                }, 3 * 1000)
            }

            function askToDelete(el) {
                if(confirm('Delete element?')) {
                    document.getElementById(el).remove();
                    generateJsonFromList()
                }
            }

        </script>
    </body>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</html>
